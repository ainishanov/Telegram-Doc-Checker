# Telegram Договор Чекер

Телеграм-бот для автоматического анализа юридических документов и контрактов с использованием ИИ.

## Функциональность

- **Анализ документов:** Загрузите любой документ (PDF, DOCX) и получите юридический анализ его содержимого
- **Определение рисков:** Выявление потенциальных рисков и проблемных пунктов в контрактах
- **Роли сторон:** Определение роли пользователя в договоре (заказчик, исполнитель и т.д.)
- **Тарифные планы:** Система подписок с различными уровнями доступа
- **Ограничение запросов:** Контроль количества запросов в зависимости от тарифа пользователя

## Технологии

- Node.js
- Telegram Bot API (webhook режим для продакшена)
- Express.js для обработки webhook запросов
- Anthropic Claude API
- Обработка документов (PDF, DOCX)
- Интеграция с платежными системами (ЮKassa, Robokassa)

## Установка и настройка

1. Клонировать репозиторий:
   ```
   git clone https://github.com/yourusername/telegram-doc-checker.git
   cd telegram-doc-checker
   ```

2. Установить зависимости:
   ```
   npm install
   ```

3. Создать файл `.env` на основе `.env.example`:
   ```
   # Основные настройки
   TELEGRAM_BOT_TOKEN=your_bot_token
   ANTHROPIC_API_KEY=your_anthropic_api_key
   
   # Настройки ЮKassa
   YOOKASSA_SHOP_ID=your_shop_id
   YOOKASSA_SECRET_KEY=your_secret_key
   YOOKASSA_RETURN_URL=https://your-domain.com/payment/success
   YOOKASSA_TEST_MODE=true
   ```

4. Запустить бот:
   ```
   npm start
   ```

## Запуск в Windows

Для удобства запуска в Windows можно использовать:
- `start_bot.bat` - запуск в стандартном режиме
- `kill_and_start_bot.cmd` - остановка предыдущих экземпляров и запуск

## Структура проекта

- `/src` - Исходный код
  - `/handlers` - Обработчики команд и документов
  - `/models` - Модели данных
  - `/utils` - Утилиты и интеграции с API
  - `/routes` - Маршруты Express для обработки запросов API
  - `/public` - Статические файлы (HTML, CSS, JS)
- `/data` - Хранение данных пользователей (создается автоматически)

## Лицензия

MIT

## Автор

Ainur Nishanov

## Возможности

- Проверка документов через пересылку в бота
- Настройка промпта для анализа с помощью ИИ
- Гибкая настройка параметров проверки
- Поддержка форматов PDF, DOC, DOCX, RTF, TXT
- Анализ договоров и юридических документов
- Выявление рисков и подводных камней
- Настройка промпта для анализа
- Система тарифных планов с ограничением запросов
- Интеграция с ЮKassa и Robokassa для приема платежей

## OCR обработка документов

Бот теперь поддерживает улучшенную OCR-обработку PDF-документов, которые содержат текст в виде изображений или защищенный от копирования текст. Функциональность OCR использует [tesseract.js](https://github.com/naptha/tesseract.js) и [pdf-to-png-converter](https://github.com/dichovsky/pdf-to-png-converter).

### Как использовать OCR

Если бот не может извлечь текст из PDF, отправьте документ с подписью "договор", чтобы принудительно обработать его с использованием OCR.

### Преимущества OCR-обработки

- Обработка защищенных PDF-документов
- Извлечение текста из сканированных документов
- Распознавание русского и английского текста
- Не требует внешних зависимостей на сервере

### Технические детали

OCR-процесс включает следующие шаги:
1. Конвертация страниц PDF в изображения PNG
2. Распознавание текста на каждом изображении с помощью Tesseract
3. Объединение распознанного текста
4. Анализ документа с помощью ИИ

## Работа с платежами

### Robokassa

1. Когда пользователь выбирает тариф и нажимает на кнопку оплаты, бот генерирует ссылку для перехода на страницу оплаты Robokassa
2. После завершения оплаты пользователь возвращается в бот и нажимает кнопку "Проверить оплату"
3. Бот делает запрос к API Robokassa для проверки статуса платежа
4. Если платеж подтвержден, бот активирует выбранный тариф

Для полноценной работы с уведомлениями необходимо настроить веб-сервер, который будет принимать уведомления от Robokassa. Это требует наличия публичного домена с SSL-сертификатом.

### ЮKassa

Бот также поддерживает интеграцию с ЮKassa для приема платежей:

1. Для настройки платежей через ЮKassa вам потребуется:
   - Зарегистрироваться в [ЮKassa](https://yookassa.ru/)
   - Получить идентификатор магазина (shopId) и секретный ключ (secretKey)
   - Указать URL для уведомлений о платежах

2. Настройка переменных окружения в файле `.env`:
   ```
   YOOKASSA_SHOP_ID=ваш_идентификатор_магазина
   YOOKASSA_SECRET_KEY=ваш_секретный_ключ
   YOOKASSA_RETURN_URL=https://ваш_домен/payment/success
   YOOKASSA_TEST_MODE=true # или false для боевого режима
   ```

3. Основные функции интеграции с ЮKassa:
   - Создание платежа (`/src/utils/yookassa-integration.js`)
   - Получение информации о платеже
   - Подтверждение платежа (для двухстадийных платежей)
   - Отмена платежа
   - Создание возврата
   - Обработка уведомлений от ЮKassa (webhook)

4. API-маршруты для работы с ЮKassa (`/src/routes/yookassaRoutes.js`):
   - `POST /yookassa/create` - создание нового платежа
   - `GET /yookassa/info/:paymentId` - получение информации о платеже
   - `POST /yookassa/capture/:paymentId` - подтверждение платежа
   - `POST /yookassa/cancel/:paymentId` - отмена платежа
   - `POST /yookassa/refund` - создание возврата
   - `POST /yookassa/webhook` - обработка уведомлений от ЮKassa

5. Тестовый режим:
   - Установите `YOOKASSA_TEST_MODE=true` в файле `.env`
   - Используйте тестовый секретный ключ, начинающийся с `test_`
   - Для тестирования используйте тестовые карты:
     - Номер: `5555 5555 5555 4444`
     - Срок действия: любой в будущем
     - CVC: любые 3 цифры
     - Код подтверждения 3-D Secure: `123`

6. Пример формы оплаты доступен по URL: `/payment-example.html`

## Пример настройки уведомлений для Robokassa

Создайте обработчик для URL-а, указанного в `ROBOKASSA_RESULT_URL`. Этот обработчик должен:

1. Проверять подпись уведомления
2. Обновлять статус платежа в базе данных
3. Возвращать "OK" в случае успешной обработки

```javascript
// Пример обработчика уведомлений от Robokassa
app.post('/robokassa/result', (req, res) => {
  const { OutSum, InvId, SignatureValue } = req.body;
  
  // Проверка подписи
  const signature = crypto.createHash('md5')
    .update(`${OutSum}:${InvId}:${process.env.ROBOKASSA_PASSWORD2}`)
    .digest('hex');
  
  if (signature.toLowerCase() !== SignatureValue.toLowerCase()) {
    return res.status(400).send('Invalid signature');
  }
  
  // Обработка платежа
  // ...
  
  res.send('OK');
});
```

## Деплой в облаке (24/7)

### Вариант 1: Render (бесплатно)

1. Создайте аккаунт на [Render](https://render.com)
2. Создайте новый Web Service и подключите репозиторий
3. Укажите тип "Web Service"
4. Укажите следующие настройки:
   - Build Command: `npm install`
   - Start Command: `node src/index.js`
5. Добавьте переменные окружения:
   - `TELEGRAM_BOT_TOKEN`
   - `ANTHROPIC_API_KEY`
   - `NODE_ENV`: production
   - `APP_URL`: URL вашего сервиса (будет доступен после деплоя)
6. Нажмите "Create Web Service"
7. После деплоя скопируйте URL вашего сервиса и добавьте его в переменную окружения `APP_URL`

### Вариант 2: Heroku

1. Установите [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli)
2. Войдите в аккаунт: `heroku login`
3. Создайте новое приложение: `heroku create`
4. Задайте переменные окружения:
   ```
   heroku config:set TELEGRAM_BOT_TOKEN=your_token
   heroku config:set ANTHROPIC_API_KEY=your_key
   heroku config:set NODE_ENV=production
   ```
5. Деплой: `git push heroku main`
6. Получите URL: `heroku info -s | grep web_url`

### Вариант 3: VPS/VDS 

1. Арендуйте VPS/VDS сервер (от 1-2$ в месяц, например на Selectel, Time Web, DigitalOcean)
2. Установите Node.js: `curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs`
3. Клонируйте репозиторий
4. Установите PM2: `npm install -g pm2`
5. Создайте `.env` файл
6. Запустите бота через PM2: `pm2 start src/index.js --name telegram-doc-checker`
7. Настройте автозапуск: `pm2 startup && pm2 save`

## Использование

1. Начните чат с ботом в Telegram
2. Отправьте команду `/start` для начала работы
3. Используйте `/help` для получения списка команд
4. Используйте `/settings` для настройки промпта и параметров проверки
5. Пересылайте документы, которые нужно проверить

## Команды

- `/start` - Начать работу с ботом
- `/help` - Показать список команд
- `/settings` - Настройка параметров проверки и промпта
- `/resetprompt` - Сбросить промпт на стандартный
- `/showprompt` - Показать текущий промпт
