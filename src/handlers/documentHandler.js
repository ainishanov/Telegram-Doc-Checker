const { downloadTelegramFile, extractTextFromDocument, downloadTelegramPhoto } = require('../utils/documentParser');
const anthropicService = require('../utils/anthropic');
const { getUserSettings } = require('../models/userSettings');
const { canUserMakeRequest, registerRequestUsage, getAllPlans, PLANS } = require('../models/userLimits');
const path = require('path');
const axios = require('axios');
const config = require('../config/config');

// –í –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤–∏–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
const pendingForceProcessing = {};

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
 * @param {Object} bot - –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ 
 * @param {Object} msg - –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º
 * @param {Object} options - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
 * @param {boolean} options.forceContract - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä
 */
async function handleDocument(bot, msg, options = {}) {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  const fileId = msg.document.file_id;
  const fileName = msg.document.file_name || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–π–ª';
  const fileExt = path.extname(fileName).toLowerCase();
  const forceContract = options.forceContract || msg._isForceContract;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å –ø–æ–¥–ø–∏—Å—å—é, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ "–¥–æ–≥–æ–≤–æ—Ä" –∏–ª–∏ "–∫–æ–Ω—Ç—Ä–∞–∫—Ç"
  const hasForceKeyword = msg.caption && 
    (/–¥–æ–≥–æ–≤–æ—Ä|–∫–æ–Ω—Ç—Ä–∞–∫—Ç|—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ|–∞–Ω–∞–ª–∏–∑/i).test(msg.caption.toLowerCase());
  const hasContractInName = (/–¥–æ–≥–æ–≤–æ—Ä|—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ|–∫–æ–Ω—Ç—Ä–∞–∫—Ç/i).test(fileName.toLowerCase());
  
  // –ï—Å–ª–∏ –≤ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –µ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const shouldForceContract = forceContract || hasForceKeyword || hasContractInName;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–∏–º–∏—Ç–æ–≤)
  const verificationCheck = canUserMakeRequest(userId);
  
  if (!verificationCheck.allowed) {
    if (verificationCheck.reason === 'subscription_inactive') {
      // –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞
      bot.sendMessage(
        chatId,
        '‚ö†Ô∏è *–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞*\n\n–í–∞—à —Ç–∞—Ä–∏—Ñ –µ—â–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /payment –¥–ª—è –æ–ø–ª–∞—Ç—ã –∏–ª–∏ /downgrade –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É.',
        { parse_mode: 'Markdown' }
      );
      return;
    } else if (verificationCheck.reason === 'limit_reached') {
      // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
      bot.sendMessage(
        chatId,
        `‚ö†Ô∏è *–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤*\n\n–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /plans –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–≤–µ—Ä–æ–∫.`,
        { parse_mode: 'Markdown' }
      );
      return;
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–≤–µ–¥–µ–º –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  const limitCheck = canUserMakeRequest(userId);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
  const supportedFormats = ['.txt', '.pdf', '.doc', '.docx', '.rtf', '.html', '.htm'];
  if (!supportedFormats.includes(fileExt)) {
    bot.sendMessage(
      chatId,
      `–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ "${fileExt}" –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ –æ–¥–Ω–æ–º –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: TXT, PDF, DOC, DOCX, RTF, HTML.`
    );
    return;
  }
  
  try {
    console.log(`–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${fileName} (${fileExt})`);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    const processingMsg = await bot.sendMessage(
      chatId, 
      `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –¥–æ–∫—É–º–µ–Ω—Ç "${fileName}" (${fileExt.replace('.', '')}), —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...`
    );
    
    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    const downloadTimeout = setTimeout(() => {
      bot.editMessageText(
        `–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${fileName}" –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–±—ã—á–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      ).catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–∞–π–º–∞—É—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏:', err));
    }, 10000); // 10 —Å–µ–∫—É–Ω–¥
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
    const filePath = await downloadTelegramFile(fileId, bot);
    clearTimeout(downloadTimeout);
    
    console.log(`–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${filePath}`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.editMessageText(
      `–ò–∑–≤–ª–µ–∫–∞—é —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${fileName}"...`, 
      {
        chat_id: chatId,
        message_id: processingMsg.message_id
      }
    );
    
    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    const extractTimeout = setTimeout(() => {
      bot.editMessageText(
        `–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${fileName}" –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–±—ã—á–Ω–æ. –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      ).catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–∞–π–º–∞—É—Ç–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞:', err));
    }, 15000); // 15 —Å–µ–∫—É–Ω–¥
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    console.log('–ù–∞—á–∏–Ω–∞—é –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...');
    
    let documentText;
    try {
      documentText = await extractTextFromDocument(filePath);
      clearTimeout(extractTimeout);
      console.log(`–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω, —Ä–∞–∑–º–µ—Ä: ${documentText ? documentText.length : 0} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω
      if (!documentText || documentText.trim() === '') {
        throw new Error('–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—É—Å—Ç');
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ –º–æ–¥—É–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
      if (documentText.startsWith('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç')) {
        throw new Error(documentText);
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ç–µ–∫—Å—Ç–µ –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      const hasImageWarning = documentText.includes('[–í–ù–ò–ú–ê–ù–ò–ï: –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
      
      // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ç–µ–∫—Å—Ç–µ –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      if (hasImageWarning) {
        // –ú—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç, –Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await bot.editMessageText(
          `‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç "${fileName}" —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞—Å—Ç–∏—á–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞...`, 
          {
            chat_id: chatId,
            message_id: processingMsg.message_id
          }
        );
      }
    } catch (extractError) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', extractError);
      
      let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞.';
      
      if (extractError.message.includes('PDF —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π') || 
          extractError.message.includes('–ø—Ä–µ–≤—ã—à–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏') ||
          extractError.message.includes('—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏')) {
        errorMessage = '–î–æ–∫—É–º–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–æ 20 –ú–ë).';
      } else if (extractError.message.includes('–∑–∞—â–∏—â–µ–Ω') || 
                extractError.message.includes('—Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è')) {
        errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –î–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø–æ–¥–ø–∏—Å—å—é "–¥–æ–≥–æ–≤–æ—Ä" –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å OCR.';
      } else if (extractError.message.includes('–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—É—Å—Ç')) {
        errorMessage = '–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø–æ–¥–ø–∏—Å—å—é "–¥–æ–≥–æ–≤–æ—Ä" –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π OCR-–æ–±—Ä–∞–±–æ—Ç–∫–∏.';
      }
      
      await bot.editMessageText(
        `‚ùå ${errorMessage}`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
      
      console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞: ${errorMessage}`);
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userSettings = getUserSettings(userId);
    
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω forceContract
    if (!shouldForceContract) {
      await bot.editMessageText(
        `–ü—Ä–æ–≤–µ—Ä—è—é, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç "${fileName}" –¥–æ–≥–æ–≤–æ—Ä–æ–º...`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
      const isContract = await isContractDocument(documentText);
      
      if (!isContract.result) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
        const hasContractInName = (/–¥–æ–≥–æ–≤–æ—Ä|—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ|–∫–æ–Ω—Ç—Ä–∞–∫—Ç/i).test(fileName.toLowerCase());
        
        if (hasContractInName) {
          console.log(`–í –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ "${fileName}" –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É`);
          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, —Ç–∞–∫ –∫–∞–∫ –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –µ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
        } else {
          try {
            // –°–æ–∑–¥–∞—ë–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã file_id
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ callback_data –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–π
            const shortId = `d${Date.now().toString(36)}_${Math.random().toString(36).substring(2, 6)}`;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
            if (!global.tempFileIdStorage) {
              global.tempFileIdStorage = {};
            }
            global.tempFileIdStorage[shortId] = fileId;
            
            console.log(`–°–æ–∑–¥–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${shortId} -> fileId (${fileId.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ callback_data
            const callbackData = `force_contract:${shortId}`;
            
            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä
            const keyboard = {
              inline_keyboard: [
                [
                  { text: '‚úÖ –î–∞, —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä', callback_data: callbackData }
                ]
              ]
            };
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –ø—Ä–∏—á–∏–Ω—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
            let rejectMessage = `‚ö†Ô∏è *–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä*\n\n${isContract.reason}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            if (isContract.reason.toLowerCase().includes('—Å—á–µ—Ç')) {
              rejectMessage += '\n\n–≠—Ç–æ—Ç –±–æ—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –∞ –Ω–µ —Å—á–µ—Ç–æ–≤ –∏–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.';
            }
            
            rejectMessage += '\n\n–ï—Å–ª–∏ —ç—Ç–æ –≤—Å—ë –∂–µ –¥–æ–≥–æ–≤–æ—Ä, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ —Å –ø–æ–¥–ø–∏—Å—å—é, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —Å–ª–æ–≤–æ "–¥–æ–≥–æ–≤–æ—Ä".';
            
            await bot.editMessageText(
              rejectMessage, 
              {
                chat_id: chatId,
                message_id: processingMsg.message_id,
                parse_mode: 'Markdown',
                reply_markup: keyboard
              }
            );
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞:', error);
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∫–Ω–æ–ø–∫–∏
            await bot.editMessageText(
              `‚ö†Ô∏è *–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä*\n\n${isContract.reason}\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ —Å –ø–æ–¥–ø–∏—Å—å—é, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π —Å–ª–æ–≤–æ "–¥–æ–≥–æ–≤–æ—Ä", —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –µ–≥–æ –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä.`, 
              {
                chat_id: chatId,
                message_id: processingMsg.message_id,
                parse_mode: 'Markdown'
              }
            );
          }
          return;
        }
      }
    } else {
      console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä');
    }
    
    // –î–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä –∏–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã –ø–µ—Ä–µ–¥ –ø–æ–ª–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
    if (!limitCheck.allowed) {
      let message = '';
      
      if (limitCheck.reason === 'limit_reached') {
        const plansInfo = getAllPlans();
        const basicPlan = plansInfo.find(plan => plan.id === 'BASIC');
        
        message = `
‚ö†Ô∏è *–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤*

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä, –Ω–æ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ (${PLANS.FREE.requestLimit} –∑–∞–ø—Ä–æ—Å–æ–≤).

–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤:

*–ë–∞–∑–æ–≤—ã–π* - ${basicPlan.price} —Ä—É–±/–º–µ—Å
‚Ä¢ –î–æ ${basicPlan.requestLimit} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–µ—Å—è—Ü
‚Ä¢ ${basicPlan.description}

–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /upgrade
`;
      } else if (limitCheck.reason === 'subscription_inactive') {
        message = '‚ö†Ô∏è *–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞*\n\n–î–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä, –Ω–æ –≤–∞—à —Ç–∞—Ä–∏—Ñ –µ—â–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /payment –¥–ª—è –æ–ø–ª–∞—Ç—ã –∏–ª–∏ /downgrade –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É.';
      }
      
      await bot.editMessageText(
        message,
        {
          chat_id: chatId,
          message_id: processingMsg.message_id,
          parse_mode: 'Markdown'
        }
      );
      return;
    }
    
    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    if (documentText.length > 30000) {
      await bot.editMessageText(
        `–î–æ–∫—É–º–µ–Ω—Ç "${fileName}" –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π (${Math.round(documentText.length / 1000)} –ö–ë). –ê–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–º–µ–Ω—è–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å.`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
      
      // –î–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—Ä–µ–º—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
      await new Promise(resolve => setTimeout(resolve, 3000));
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∞–Ω–∞–ª–∏–∑–∞
    await bot.editMessageText(
      shouldForceContract 
        ? `–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç "${fileName}" –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä...\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç.`
        : `–î–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç.`, 
      {
        chat_id: chatId,
        message_id: processingMsg.message_id
      }
    );
    
    // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    const analysisTimeout = setTimeout(() => {
      bot.editMessageText(
        `–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "${fileName}" –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–±—ã—á–Ω–æ. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã —Ç–µ–∫—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      ).catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–∞–π–º–∞—É—Ç–µ –∞–Ω–∞–ª–∏–∑–∞:', err));
    }, 45000); // 45 —Å–µ–∫—É–Ω–¥
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    const hasStructuredText = checkTextStructure(documentText);
    if (!hasStructuredText) {
      clearTimeout(analysisTimeout);
      // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É —à–∞–±–ª–æ–Ω –¥–ª—è –Ω–µ–ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
      console.log('–¢–µ–∫—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —à–∞–±–ª–æ–Ω');
      
      // –°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω —Å –ø–æ–º–µ—Ç–∫–æ–π –æ –Ω–µ–ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      const analysis = {
        isContract: true,
        party1: {
          role: "–ü–µ—Ä–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞", 
          name: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å"
        },
        party2: {
          role: "–í—Ç–æ—Ä–∞—è —Å—Ç–æ—Ä–æ–Ω–∞",
          name: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å"
        },
        mainTerms: {
          subject: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
          price: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
          duration: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
          responsibilities: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π",
          special: "–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."
        },
        analysis: {
          party1Analysis: {
            criticalErrors: ["–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"],
            risks: ["–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ä–∏—Å–∫–∏ –∏–∑-–∑–∞ –Ω–µ–ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞"],
            advantages: ["–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"],
            disadvantages: ["–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"],
            improvements: ["–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"]
          },
          party2Analysis: {
            criticalErrors: ["–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"],
            risks: ["–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ä–∏—Å–∫–∏ –∏–∑-–∑–∞ –Ω–µ–ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞"],
            advantages: ["–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"],
            disadvantages: ["–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"],
            improvements: ["–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"]
          }
        },
        conclusion: {
          mainProblems: ["–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –µ–≥–æ –∞–Ω–∞–ª–∏–∑"],
          recommendedActions: [
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã OCR –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ç–µ–∫—Å—Ç",
            "–ï—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DOC/DOCX"
          ]
        },
        incomplete: true
      };
      
      // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log('–ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤):');
      console.log(documentText.substring(0, 200));
      console.log('–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', documentText.length);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
      if (!global.tempStorage) {
        global.tempStorage = {};
      }
      global.tempStorage[userId] = {
        analysis,
        documentId: fileId
      };

      // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã
      const keyboard = {
        inline_keyboard: [
          [
            { 
              text: `${analysis.party1.role}`, 
              callback_data: `select_party:${userId}:party1` 
            }
          ],
          [
            { 
              text: `${analysis.party2.role}`, 
              callback_data: `select_party:${userId}:party2` 
            }
          ]
        ]
      };
      
      // –í—Ä–µ–º–µ–Ω–Ω–æ - –¥–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
      const analysisTitle = "–î–æ–∫—É–º–µ–Ω—Ç —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π OCR-–ø—Ä–æ–±–ª–µ–º–æ–π";
      const forceMessage = createIncompleteAnalysisTemplate(documentText, analysisTitle, true) +
        `‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ:* –ê–ª–≥–æ—Ä–∏—Ç–º –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.\n\n` +
        `*–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*\n` +
        `‚Ä¢ –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: ${documentText.length} —Å–∏–º–≤–æ–ª–æ–≤\n` +
        `‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ OCR\n\n` +
        `*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*\n` +
        `1. –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç (–∞ –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è), –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –≤ –¥—Ä—É–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (DOC, DOCX, TXT)\n` +
        `2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã OCR –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è PDF –≤ —Ç–µ–∫—Å—Ç:\n` +
        `   - pdf.online/ru/pdf-ocr\n` +
        `   - onlineocr.net/ru\n\n` +
        `–í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç":`;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
      pendingForceProcessing[userId] = {
        fileId: fileId,
        processingMsgId: processingMsg.message_id,
        documentText: documentText,
        timestamp: Date.now()
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      await bot.editMessageText(forceMessage, {
        chat_id: chatId,
        message_id: processingMsg.message_id,
        parse_mode: 'Markdown',
        disable_web_page_preview: true,
        reply_markup: keyboard
      });
      
      console.log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞');
      return;
    }
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    let analysis;
    try {
      analysis = await analyzeDocumentWithSelectedModel(documentText);
      clearTimeout(analysisTimeout);
    } catch (analysisError) {
      clearTimeout(analysisTimeout);
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', analysisError);
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –æ—à–∏–±–æ–∫ –∞–Ω–∞–ª–∏–∑–∞
      let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.';
      
      if (analysisError.message.includes('context_length_exceeded') || 
          analysisError.message.includes('maximum context length')) {
        errorMessage = '–î–æ–∫—É–º–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞.';
      } else if (analysisError.message.includes('–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—É—Å—Ç')) {
        errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
      } else if (analysisError.message.includes('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞')) {
        errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞. –í–æ–∑–º–æ–∂–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç –∏–º–µ–µ—Ç –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω.';
      } else if (analysisError.message.includes('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç')) {
        errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥—Ä—É–≥–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ñ–æ—Ä–º–∞—Ç–µ DOCX).';
      } 
      
      // –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–æ–±–ª–µ–º–µ
      await bot.editMessageText(
        `‚ùå ${errorMessage}`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
      
      console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ${errorMessage}`);
      return;
    }
    
    console.log('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, —Ñ–æ—Ä–º–∏—Ä—É—é –æ—Ç–≤–µ—Ç...');
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    registerRequestUsage(userId);
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ª–∏–º–∏—Ç–∞—Ö
    const updatedLimits = canUserMakeRequest(userId);
    let limitInfo = '';
    
    if (updatedLimits.remainingRequests === 0) {
      limitInfo = '\n\n‚ö†Ô∏è –≠—Ç–æ –±—ã–ª –≤–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /upgrade.';
    } else if (updatedLimits.remainingRequests <= 2 && PLANS.FREE.requestLimit <= 3) {
      limitInfo = `\n\n‚ö†Ô∏è –£ –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å ${updatedLimits.remainingRequests} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.`;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
    if (!global.tempStorage) {
      global.tempStorage = {};
    }
    global.tempStorage[userId] = {
      analysis,
      documentId: fileId
    };

    // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã
    const keyboard = {
      inline_keyboard: [
        [
          { 
            text: `${analysis.party1.role} (${analysis.party1.name})`, 
            callback_data: `select_party:${userId}:party1` 
          }
        ],
        [
          { 
            text: `${analysis.party2.role} (${analysis.party2.name})`, 
            callback_data: `select_party:${userId}:party2` 
          }
        ]
      ]
    };

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
    const message = analysis.incomplete 
      ? createIncompleteAnalysisTemplate(documentText, "–ß–∞—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞", true) +
        `*–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞:*\n` +
        `1Ô∏è‚É£ ${analysis.party1.role}: *${analysis.party1.name}*\n` +
        `2Ô∏è‚É£ ${analysis.party2.role}: *${analysis.party2.name}*\n\n` +
        `–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π –¥–æ–≥–æ–≤–æ—Ä–∞ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å:${limitInfo}`
      : `üìÑ *–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω*\n\n` +
        `*–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞:*\n` +
        `1Ô∏è‚É£ ${analysis.party1.role}: *${analysis.party1.name}*\n` +
        `2Ô∏è‚É£ ${analysis.party2.role}: *${analysis.party2.name}*\n\n` +
        `–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π –¥–æ–≥–æ–≤–æ—Ä–∞ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å:${limitInfo}`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    await bot.editMessageText(message, {
      chat_id: chatId,
      message_id: processingMsg.message_id,
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
    
    console.log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.';
    
    if (error.message.includes('–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—É—Å—Ç')) {
      errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.';
    } else if (error.message.includes('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞')) {
      errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –¥–æ–≥–æ–≤–æ—Ä–æ–º –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö.';
    } else if (error.message.includes('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç')) {
      errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.';
    } else if (error.code === 'context_length_exceeded' || error.message.includes('maximum context length')) {
      errorMessage = '–î–æ–∫—É–º–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞.';
    } else if (error.message.includes('response_format') || error.param === 'response_format') {
      errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ. –ú—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ –µ—ë —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
    }
    
    bot.sendMessage(chatId, `‚ùå ${errorMessage}`);
  }
}

/**
 * –î–µ–ª–∏—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
 * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
 * @param {number} maxPartLength - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —á–∞—Å—Ç–∏
 * @returns {Array<string>} - –ú–∞—Å—Å–∏–≤ —á–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞
 */
function splitTextIntoParts(text, maxPartLength) {
  const parts = [];
  let currentPart = '';
  
  // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
  const sentences = text.split(/(?<=[.!?])\s+/);
  
  for (const sentence of sentences) {
    // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–µ–≤—ã—Å–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É —á–∞—Å—Ç–∏
    if ((currentPart + sentence).length > maxPartLength) {
      // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è —á–∞—Å—Ç—å –Ω–µ –ø—É—Å—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–µ –≤ –º–∞—Å—Å–∏–≤
      if (currentPart) {
        parts.push(currentPart);
        currentPart = '';
      }
      
      // –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –¥–ª—è –æ–¥–Ω–æ–π —á–∞—Å—Ç–∏
      if (sentence.length > maxPartLength) {
        // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏
        let remainingSentence = sentence;
        while (remainingSentence.length > 0) {
          const partLength = Math.min(remainingSentence.length, maxPartLength);
          parts.push(remainingSentence.substring(0, partLength));
          remainingSentence = remainingSentence.substring(partLength);
        }
      } else {
        currentPart = sentence;
      }
    } else {
      currentPart += sentence;
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —á–∞—Å—Ç—å, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞
  if (currentPart) {
    parts.push(currentPart);
  }
  
  return parts;
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã
async function handlePartySelection(bot, query) {
  console.log(`–ü–æ–ª—É—á–µ–Ω callback –∑–∞–ø—Ä–æ—Å: ${query.data}`);
  
  // –°—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query, —á—Ç–æ–±—ã Telegram –Ω–µ —Å—á–∏—Ç–∞–ª –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–º
  await bot.answerCallbackQuery(query.id, {
    text: "–ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞..."
  }).catch(err => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ callback:', err.message));
  
  const userId = query.from.id.toString();
  const chatId = query.message.chat.id;
  const data = query.data;
  const [action, user, party] = data.split(':');

  console.log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã: action=${action}, user=${user}, party=${party}`);

  if (action !== 'select_party' || user !== userId) {
    console.log('–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ action –∏–ª–∏ userId, –≤—ã—Ö–æ–¥ –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞');
    return;
  }

  try {
    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è tempStorage...');
    if (!global.tempStorage) {
      console.log('tempStorage –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç');
      global.tempStorage = {};
    }

    console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ tempStorage –¥–ª—è userId=${userId}`);
    const userData = global.tempStorage[userId];
    if (!userData || !userData.analysis) {
      console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ tempStorage');
      await bot.answerCallbackQuery(query.id, { 
        text: '–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ.',
        show_alert: true
      });
      return;
    }
    
    console.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–¥–æ–ª–∂–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...');

    console.log('–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞ –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã...');
    const analysis = userData.analysis;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∞–Ω–∞–ª–∏–∑–µ
    if (!analysis.party1 || !analysis.party2) {
      console.error('–û—à–∏–±–∫–∞: –≤ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞');
      await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞: –≤ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö –¥–æ–≥–æ–≤–æ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ.');
      delete global.tempStorage[userId];
      return;
    }
    
    const selectedParty = party === 'party1' ? analysis.party1 : analysis.party2;
    const otherParty = party === 'party1' ? analysis.party2 : analysis.party1;
    
    console.log(`–í—ã–±—Ä–∞–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞: ${selectedParty.role} (${selectedParty.name})`);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    if (!analysis.analysis || 
        (party === 'party1' && !analysis.analysis.party1Analysis) || 
        (party === 'party2' && !analysis.analysis.party2Analysis)) {
      console.error('–û—à–∏–±–∫–∞: –≤ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã');
      await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞: –≤ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ.');
      delete global.tempStorage[userId];
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    const partyAnalysis = party === 'party1' ? analysis.analysis.party1Analysis : analysis.analysis.party2Analysis;
    console.log('–ê–Ω–∞–ª–∏–∑ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ø–æ–ª—É—á–µ–Ω');

    try {
      console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞...');
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞
      await bot.deleteMessage(chatId, query.message.message_id).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err.message);
      });
    } catch (deleteError) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', deleteError);
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    }

    // –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –±—ã–ª –Ω–µ–ø–æ–ª–Ω—ã–º –∏–∑-–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    if (analysis.incomplete) {
      console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ–ø–æ–ª–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å OCR...');
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
      const incompleteMessage = `‚ö†Ô∏è *–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏*\n\n` +
        `–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –≤ –≤–∏–¥–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –µ–≥–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑.\n\n` +
        `*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:*\n` +
        `1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (DOC, DOCX, TXT)\n` +
        `2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã OCR –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è PDF –≤ —Ç–µ–∫—Å—Ç:\n` +
        `   - https://pdf.online/ru/pdf-ocr\n` +
        `   - https://www.onlineocr.net/ru/\n\n` +
        `–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥—Ä—É–≥–∞—è –≤–µ—Ä—Å–∏—è —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.`;
        
      try {
        await bot.sendMessage(chatId, incompleteMessage, { 
          parse_mode: 'Markdown',
          disable_web_page_preview: true 
        });
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–ø–æ–ª–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      } catch (sendError) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ–ø–æ–ª–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ:', sendError);
      }
      
      // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
      console.log('–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è userId:', userId);
      delete global.tempStorage[userId];
      
      return;
    }

    // –°–û–û–ë–©–ï–ù–ò–ï 1: –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞
    let termsMessage = `üìã *–°–£–©–ï–°–¢–í–ï–ù–ù–´–ï –£–°–õ–û–í–ò–Ø –î–û–ì–û–í–û–†–ê*\n\n`;
    
    // –°—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞
    termsMessage += `*1Ô∏è‚É£ –°–¢–û–†–û–ù–´ –î–û–ì–û–í–û–†–ê:*\n`;
    termsMessage += `‚Ä¢ ${analysis.party1.role}: *${analysis.party1.name}*\n`;
    termsMessage += `‚Ä¢ ${analysis.party2.role}: *${analysis.party2.name}*\n\n`;
    
    // –ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞
    termsMessage += `*2Ô∏è‚É£ –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê:*\n`;
    termsMessage += `${analysis.mainTerms.subject}\n\n`;
    
    // –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫ –æ–ø–ª–∞—Ç—ã
    termsMessage += `*3Ô∏è‚É£ –°–¢–û–ò–ú–û–°–¢–¨ –ò –ü–û–†–Ø–î–û–ö –û–ü–õ–ê–¢–´:*\n`;
    termsMessage += `${analysis.mainTerms.price}\n\n`;
    
    // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
    termsMessage += `*4Ô∏è‚É£ –°–†–û–ö –î–ï–ô–°–¢–í–ò–Ø –î–û–ì–û–í–û–†–ê:*\n`;
    termsMessage += `${analysis.mainTerms.duration}\n\n`;
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω
    termsMessage += `*5Ô∏è‚É£ –û–°–ù–û–í–ù–´–ï –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò –°–¢–û–†–û–ù:*\n`;
    termsMessage += `${analysis.mainTerms.responsibilities}\n\n`;
    
    // –û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è
    if (analysis.mainTerms.special && analysis.mainTerms.special !== '–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã—è–≤–ª–µ–Ω—ã') {
      termsMessage += `*6Ô∏è‚É£ –û–°–û–ë–´–ï –£–°–õ–û–í–ò–Ø:*\n`;
      termsMessage += `${analysis.mainTerms.special}\n\n`;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏
    await bot.sendMessage(chatId, termsMessage, { parse_mode: 'Markdown' });

    // –°–û–û–ë–©–ï–ù–ò–ï 2: –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    let analysisMessage = `*–ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø –£–°–õ–û–í–ò–ô –î–û–ì–û–í–û–†–ê*\n\n`;
    
    let sectionNumber = 1;
    
    // –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, —Ç—Ä–µ–±—É—é—â–∏–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è
    if (partyAnalysis.criticalErrors && partyAnalysis.criticalErrors.length > 0) {
      analysisMessage += `*${sectionNumber}. –ú–û–ú–ï–ù–¢–´, –ö–û–¢–û–†–´–ï –ú–û–ì–£–¢ –ü–û–¢–†–ï–ë–û–í–ê–¢–¨ –û–ë–°–£–ñ–î–ï–ù–ò–Ø:*\n\n`;
      partyAnalysis.criticalErrors.forEach((error, index) => {
        analysisMessage += `${index + 1}. ${error}\n`;
      });
      analysisMessage += '\n';
      sectionNumber++;
    }
    
    // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ —É—Å–ª–æ–≤–∏–π
    if (partyAnalysis.improvements && partyAnalysis.improvements.length > 0) {
      analysisMessage += `*${sectionNumber}. –ü–£–ù–ö–¢–´, –ö–û–¢–û–†–´–ï –ú–û–ñ–ù–û –û–ë–°–£–î–ò–¢–¨ –î–õ–Ø –ë–û–õ–¨–®–ï–ô –Ø–°–ù–û–°–¢–ò:*\n\n`;
      partyAnalysis.improvements.forEach((imp, index) => {
        analysisMessage += `${index + 1}. ${imp}\n`;
      });
      analysisMessage += '\n';
      sectionNumber++;
    }
    
    // –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è
    if (partyAnalysis.risks && partyAnalysis.risks.length > 0) {
      analysisMessage += `*${sectionNumber}. –í–û–ü–†–û–°–´ –î–õ–Ø –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø –° –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–ú:*\n\n`;
      partyAnalysis.risks.forEach((risk, index) => {
        analysisMessage += `${index + 1}. ${risk}\n`;
      });
      analysisMessage += '\n';
      sectionNumber++;
    }
    
    // –ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    if (analysis.conclusion.mainProblems && analysis.conclusion.mainProblems.length > 0) {
      analysisMessage += `*${sectionNumber}. –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –í–û–ü–†–û–°–´ –î–õ–Ø –£–¢–û–ß–ù–ï–ù–ò–Ø:*\n\n`;
      analysis.conclusion.mainProblems.forEach((problem, index) => {
        analysisMessage += `${index + 1}. ${problem}\n`;
      });
      analysisMessage += '\n';
      sectionNumber++;
    }
    
    if (analysis.conclusion.recommendedActions && analysis.conclusion.recommendedActions.length > 0) {
      analysisMessage += `*${sectionNumber}. –í–û–ó–ú–û–ñ–ù–´–ï –®–ê–ì–ò –ü–û –†–ê–ë–û–¢–ï –° –î–û–ì–û–í–û–†–û–ú:*\n\n`;
      analysis.conclusion.recommendedActions.forEach((action, index) => {
        analysisMessage += `${index + 1}. ${action}\n`;
      });
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–Ω–∞–ª–∏–∑–æ–º
    await bot.sendMessage(chatId, analysisMessage, { parse_mode: 'Markdown' });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–µ—Ç—å–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é
    await bot.sendMessage(chatId, '‚¨ÜÔ∏è *–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—ã—à–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π –¥–æ–≥–æ–≤–æ—Ä–∞*', { parse_mode: 'Markdown' });

    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    delete global.tempStorage[userId];

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã:', error);
    await bot.answerCallbackQuery(query.id, { 
      text: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—ã–±–æ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å–Ω–æ–≤–∞.',
      show_alert: true 
    });
  }
}

async function analyzeDocumentWithSelectedModel(text) {
  return await anthropicService.analyzeDocument(text);
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
async function isContractDocument(text) {
  if (!text || text.trim() === '') {
    return { 
      result: false, 
      reason: '–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞'
    };
  }
  
  console.log('–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–∞...');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5000 —Å–∏–º–≤–æ–ª–æ–≤
  // –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 50000 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  const lowerText = text.toLowerCase().substring(0, Math.min(text.length, 50000));
  
  // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞
  const contractKeywords = [
    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤
    '–¥–æ–≥–æ–≤–æ—Ä', '—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ', '–∫–æ–Ω—Ç—Ä–∞–∫—Ç', '–¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å', 
    '–ø—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞', '–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω', '—É—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞',
    '–Ω–∞—Å—Ç–æ—è—â–∏–π –¥–æ–≥–æ–≤–æ—Ä', '–æ–±—è–∑—É–µ—Ç—Å—è', '–∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π',
    '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–∑–∞–∫–∞–∑—á–∏–∫', '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω',
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
    '—Å—Ç–æ—Ä–æ–Ω—ã', '–∏–º–µ–Ω—É–µ–º—ã–π', '–∏–º–µ–Ω—É–µ–º–∞—è', '–≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º', '–≤ –ª–∏—Ü–µ',
    '–¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏', '—Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã', '—Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã',
    '–ø—Ä–µ–¥–º–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏—è', '—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è', '—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞',
    '–ø–æ—Ä—è–¥–æ–∫ —Ä–∞—Å—á–µ—Ç–æ–≤', '–ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏', '—Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä',
    '—Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Å—Ç–æ—Ä–æ–Ω', '–ø–æ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä–æ–Ω', '–∞–∫—Ç –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏',
    
    // –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
    '–∞—Ä–±–∏—Ç—Ä–∞–∂', '–ø—Ä–µ—Ç–µ–Ω–∑–∏—è', '–Ω–µ—É—Å—Ç–æ–π–∫–∞', '—à—Ç—Ä–∞—Ñ', '–ø–µ–Ω—è',
    '–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å', '—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ –¥–æ–≥–æ–≤–æ—Ä—É',
    '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ', '–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞'
  ];
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–æ–≥–æ–≤–æ—Ä–∞ (—Ä–∞–∑–¥–µ–ª—ã)
  const contractSections = [
    '–ø—Ä–µ–¥–º–µ—Ç', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø–æ—Ä—è–¥–æ–∫', '—Å—Ä–æ–∫', '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å',
    '–ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏', '—Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä', '—Ä–µ–∫–≤–∏–∑–∏—Ç—ã', '–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'
  ];
  
  // –ü–æ–¥—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  const contractKeywordsCount = contractKeywords.filter(keyword => 
    lowerText.includes(keyword.toLowerCase())
  ).length;
  
  // –ü–æ–¥—Å—á–µ—Ç —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞
  const sectionMatches = contractSections.filter(section => {
    // –ò—â–µ–º —Ä–∞–∑–¥–µ–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ "1. –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê" –∏–ª–∏ "–†–∞–∑–¥–µ–ª 1. –ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞"
    const patterns = [
      new RegExp(`\\d+\\.\\s*${section}`, 'i'),  // "1. –ø—Ä–µ–¥–º–µ—Ç"
      new RegExp(`—Ä–∞–∑–¥–µ–ª\\s+\\d+\\.\\s*${section}`, 'i'),  // "—Ä–∞–∑–¥–µ–ª 1. –ø—Ä–µ–¥–º–µ—Ç"
      new RegExp(`${section}\\s+–¥–æ–≥–æ–≤–æ—Ä–∞`, 'i')  // "–ø—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞"
    ];
    
    return patterns.some(pattern => pattern.test(lowerText));
  }).length;
  
  console.log(`–ù–∞–π–¥–µ–Ω–æ ${contractKeywordsCount} –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ ${sectionMatches} —Ä–∞–∑–¥–µ–ª–æ–≤`);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å—Ç–æ—Ä–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞
  const hasParties = /—Å—Ç–æ—Ä–æ–Ω[–∞—ã]|–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å|–∑–∞–∫–∞–∑—á–∏–∫|–ø–æ–¥—Ä—è–¥—á–∏–∫|–ø–æ—Å—Ç–∞–≤—â–∏–∫|–ø–æ–∫—É–ø–∞—Ç–µ–ª—å|–ø—Ä–æ–¥–∞–≤–µ—Ü|–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä|–∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å/i.test(lowerText);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–ø–∏—Å–µ–π
  const hasSignatures = /–ø–æ–¥–ø–∏—Å[—å–∏]|–º\.–ø\.|–º–µ—Å—Ç–æ –ø–µ—á–∞—Ç–∏|–¥–∏—Ä–µ–∫—Ç–æ—Ä|–≥–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä/i.test(lowerText);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
  const hasRequisites = /—Ä–µ–∫–≤–∏–∑–∏—Ç—ã|–∞–¥—Ä–µ—Å|–∏–Ω–Ω|–∫–ø–ø|–æ–≥—Ä–Ω|—Ä\/—Å—á|—Ä\/—Å|–±–∏–∫|–∫\/—Å/i.test(lowerText);
  
  // –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
  // –î–æ–∫—É–º–µ–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–æ–≥–æ–≤–æ—Ä–æ–º, –µ—Å–ª–∏:
  // 1. –°–æ–¥–µ—Ä–∂–∏—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (>= 3)
  // 2. –ò–õ–ò –∏–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–≥–æ–≤–æ—Ä–∞ (>= 2 —Ä–∞–∑–¥–µ–ª–∞)
  // 3. –ò–õ–ò —Å–æ–¥–µ—Ä–∂–∏—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –ò (–ø–æ–¥–ø–∏—Å–∏ –ò–õ–ò —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)
  
  if (contractKeywordsCount >= 3 || sectionMatches >= 2 || (hasParties && (hasSignatures || hasRequisites))) {
    console.log('–î–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞');
    return { 
      result: true, 
      reason: `–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ (–Ω–∞–π–¥–µ–Ω–æ ${contractKeywordsCount} –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, ${sectionMatches} —Ä–∞–∑–¥–µ–ª–æ–≤)`
    };
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—á–µ—Ç
  if (lowerText.includes('—Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É') || lowerText.includes('—Å—á–µ—Ç-—Ñ–∞–∫—Ç—É—Ä–∞') || 
      lowerText.includes('—Å—á–µ—Ç ‚Ññ') || lowerText.includes('—Å—á—ë—Ç ‚Ññ') ||
      /—Å—á–µ—Ç\s+–æ—Ç\s+\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4}/i.test(lowerText)) {
    return { 
      result: false, 
      reason: '–î–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è —Å—á–µ—Ç–æ–º (–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —è–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å—á–µ—Ç–∞)'
    };
  }
  
  // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ –¥–æ–≥–æ–≤–æ—Ä –∏ –ø—Ä–æ—Å–∏–º —É—Ç–æ—á–Ω–∏—Ç—å
  return {
    result: false,
    reason: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ï—Å–ª–∏ —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —ç—Ç–æ —è–≤–Ω–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.'
  };
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
 * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @returns {boolean} - –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
 */
function checkTextStructure(text) {
  if (!text) {
    return false;
  }
  
  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π (–º–µ–Ω–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤), –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ OCR –ø—Ä–æ–±–ª–µ–º–∞
  if (text.length < 200) {
    console.log(`–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (${text.length} —Å–∏–º–≤–æ–ª–æ–≤), –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ OCR –ø—Ä–æ–±–ª–µ–º–∞`);
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–æ–≥–æ–≤–æ—Ä–∞
  const keywords = [
    '–¥–æ–≥–æ–≤–æ—Ä', '—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ', '–∫–æ–Ω—Ç—Ä–∞–∫—Ç', '—Å—Ç–æ—Ä–æ–Ω—ã', '–ø—Ä–µ–¥–º–µ—Ç', '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å', '–∑–∞–∫–∞–∑—á–∏–∫',
    '–æ–±—è–∑—É–µ—Ç—Å—è', '–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏', '–ø—Ä–∞–≤–∞', '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', '–ø–æ—Ä—è–¥–æ–∫', '—É—Å–ª–æ–≤–∏—è', '–æ–ø–ª–∞—Ç–∞'
  ];
  
  let keywordsFound = 0;
  keywords.forEach(keyword => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ —Å–ª–æ–≤–∞ —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü —Å–ª–æ–≤
    const regex = new RegExp(`\\b${keyword}\\b`, 'i');
    if (regex.test(text)) {
      keywordsFound++;
    }
  });
  
  console.log(`–ù–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: ${keywordsFound} –∏–∑ ${keywords.length}`);
  
  // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ —Ö–æ—Ç—è –±—ã 2 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤–∞, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
  if (keywordsFound >= 2) {
    return true;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—É–Ω–∫—Ç–æ–≤ (1.1., 2.3. –∏ —Ç.–¥.)
  const hasParagraphStructure = /\d+\.\d+\./.test(text);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
  const sentences = text.split(/[.!?][\s\n]+/).filter(s => s.trim().length > 10);
  const hasEnoughSentences = sentences.length >= 3;
  
  console.log(`–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—É–Ω–∫—Ç–æ–≤: ${hasParagraphStructure}, –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${hasEnoughSentences}`);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–≤—É—Ö –∏–ª–∏ –±–æ–ª–µ–µ —Å—Ç–æ—Ä–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞
  // (–æ–±—ã—á–Ω–æ –¥–≤–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –ò–ü –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü–∞)
  const orgMatches = text.match(/–û–û–û|–ü–ê–û|–ê–û|–ò–ü|¬´[^¬ª]+¬ª|"[^"]+"|\b–ò–ù–ù\b|\b–û–ì–†–ù\b/gi) || [];
  const hasOrganizations = orgMatches.length >= 1;
  
  console.log(`–ù–∞–π–¥–µ–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π/–ò–ü: ${orgMatches.length}`);
  
  // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏, 
  // —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
  return (keywordsFound >= 1 && (hasParagraphStructure || hasEnoughSentences || hasOrganizations)) ||
         // –ï—Å–ª–∏ –º–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, —Ç–æ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
         hasEnoughSentences;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç
async function handleTextMessage(bot, msg) {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  const text = msg.text || '';
  
  if (!text || !text.toLowerCase().includes('–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç')) {
    return false; // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  if (!pendingForceProcessing[userId]) {
    return false;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ñ–∞–π–ª–µ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const { fileId, processingMsgId, documentText } = pendingForceProcessing[userId];
  
  if (!fileId || !processingMsgId || !documentText) {
    await bot.sendMessage(chatId, '–ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç —Å–Ω–æ–≤–∞.');
    delete pendingForceProcessing[userId];
    return true;
  }
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  await bot.editMessageText(
    '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç...',
    {
      chat_id: chatId,
      message_id: processingMsgId
    }
  );
  
  try {
    // –°–æ–∑–¥–∞–µ–º –æ–ø—Ü–∏—é –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    const options = { forceContract: true };
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
    const limitCheck = canUserMakeRequest(userId);
    if (!limitCheck.allowed) {
      let message = '';
      
      if (limitCheck.reason === 'limit_reached') {
        const plansInfo = getAllPlans();
        const basicPlan = plansInfo.find(plan => plan.id === 'BASIC');
        
        message = `
‚ö†Ô∏è *–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤*

–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ (${PLANS.FREE.requestLimit} –∑–∞–ø—Ä–æ—Å–æ–≤).

–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤:

*–ë–∞–∑–æ–≤—ã–π* - ${basicPlan.price} —Ä—É–±/–º–µ—Å
‚Ä¢ –î–æ ${basicPlan.requestLimit} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–µ—Å—è—Ü
‚Ä¢ ${basicPlan.description}

–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /upgrade
`;
      } else if (limitCheck.reason === 'subscription_inactive') {
        message = '‚ö†Ô∏è *–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞*\n\n–í–∞—à —Ç–∞—Ä–∏—Ñ –µ—â–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /payment –¥–ª—è –æ–ø–ª–∞—Ç—ã –∏–ª–∏ /downgrade –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É.';
      }
      
      await bot.editMessageText(
        message,
        {
          chat_id: chatId,
          message_id: processingMsgId,
          parse_mode: 'Markdown'
        }
      );
      
      delete pendingForceProcessing[userId];
      return true;
    }
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    await bot.editMessageText(
      `–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞...\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç.`, 
      {
        chat_id: chatId,
        message_id: processingMsgId
      }
    );
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    const analysis = await analyzeDocumentWithSelectedModel(documentText);
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    registerRequestUsage(userId);
    
    // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ª–∏–º–∏—Ç–∞—Ö
    const updatedLimits = canUserMakeRequest(userId);
    let limitInfo = '';
    
    if (updatedLimits.remainingRequests === 0) {
      limitInfo = '\n\n‚ö†Ô∏è –≠—Ç–æ –±—ã–ª –≤–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /upgrade.';
    } else if (updatedLimits.remainingRequests <= 2 && PLANS.FREE.requestLimit <= 3) {
      limitInfo = `\n\n‚ö†Ô∏è –£ –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å ${updatedLimits.remainingRequests} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.`;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
    if (!global.tempStorage) {
      global.tempStorage = {};
    }
    global.tempStorage[userId] = {
      analysis,
      documentId: fileId
    };

    // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–æ—Ä–æ–Ω—ã
    const keyboard = {
      inline_keyboard: [
        [
          { 
            text: `${analysis.party1.role} (${analysis.party1.name})`, 
            callback_data: `select_party:${userId}:party1` 
          }
        ],
        [
          { 
            text: `${analysis.party2.role} (${analysis.party2.name})`, 
            callback_data: `select_party:${userId}:party2` 
          }
        ]
      ]
    };

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
    const message = createIncompleteAnalysisTemplate(documentText, "–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞") +
      `*–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞:*\n` +
      `1Ô∏è‚É£ ${analysis.party1.role}: *${analysis.party1.name}*\n` +
      `2Ô∏è‚É£ ${analysis.party2.role}: *${analysis.party2.name}*\n\n` +
      `–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π –¥–æ–≥–æ–≤–æ—Ä–∞ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å:${limitInfo}`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    await bot.editMessageText(message, {
      chat_id: chatId,
      message_id: processingMsgId,
      parse_mode: 'Markdown',
      reply_markup: keyboard
    });
    
    console.log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞:', error);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—Å—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞.';
    
    if (error.message.includes('context_length_exceeded') || 
        error.message.includes('maximum context length')) {
      errorMessage = '–î–æ–∫—É–º–µ–Ω—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ–≥–æ–≤–æ—Ä–∞.';
    } else if (error.message.includes('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞')) {
      errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≥–æ–≤–æ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –¥–æ–≥–æ–≤–æ—Ä–æ–º –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ—Ä–æ–Ω–∞—Ö.';
    } else if (error.message.includes('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç')) {
      errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.';
    }
    
    await bot.editMessageText(
      `‚ùå ${errorMessage}`,
      {
        chat_id: chatId,
        message_id: processingMsgId
      }
    );
  }
  
  // –û—á–∏—â–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
  delete pendingForceProcessing[userId];
  return true;
}

// –°–æ–∑–¥–∞–µ—Ç —à–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –Ω–µ–ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
function createIncompleteAnalysisTemplate(documentText, analysisTitle, isImageDetected = false) {
  let template = `üìÑ *${analysisTitle}*\n\n`;
  
  // –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
  if (isImageDetected) {
    template += `‚ö†Ô∏è *–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è*\n`;
    template += `–ê–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º, —Ç–∞–∫ –∫–∞–∫ —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.\n\n`;
    template += `üîç *–•–æ—Ç–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç?*\n`;
    template += `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ: \`–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç\`\n\n`;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  const previewText = documentText.substring(0, 200).trim();
  template += `*–§—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞:*\n${previewText}${documentText.length > 200 ? '...' : ''}\n\n`;
  
  return template;
}

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
 * @param {Object} bot - –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
 * @param {Object} msg - –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π
 * @param {Object} options - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
 * @param {boolean} options.forceContract - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –¥–æ–≥–æ–≤–æ—Ä
 */
async function handlePhoto(bot, msg, options = {}) {
  const chatId = msg.chat.id;
  const userId = msg.from.id.toString();
  
  // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (—Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã)
  const photos = msg.photo;
  // –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ —Å –Ω–∞–∏–ª—É—á—à–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ –º–∞—Å—Å–∏–≤–µ)
  const fileId = photos[photos.length - 1].file_id;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
  const fileName = `photo_${Date.now()}.jpg`;
  const forceContract = options.forceContract || false;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å –ø–æ–¥–ø–∏—Å—å—é, —Å–æ–¥–µ—Ä–∂–∞—â–µ–π –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ "–¥–æ–≥–æ–≤–æ—Ä" –∏–ª–∏ "–∫–æ–Ω—Ç—Ä–∞–∫—Ç"
  const hasForceKeyword = msg.caption && 
    (/–¥–æ–≥–æ–≤–æ—Ä|–∫–æ–Ω—Ç—Ä–∞–∫—Ç|—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ|–∞–Ω–∞–ª–∏–∑/i).test(msg.caption.toLowerCase());
  
  // –ï—Å–ª–∏ –≤ –ø–æ–¥–ø–∏—Å–∏ –µ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const shouldForceContract = forceContract || hasForceKeyword;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–∏–º–∏—Ç–æ–≤)
  const verificationCheck = canUserMakeRequest(userId);
  
  if (!verificationCheck.allowed) {
    if (verificationCheck.reason === 'subscription_inactive') {
      // –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞
      bot.sendMessage(
        chatId,
        '‚ö†Ô∏è *–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞*\n\n–í–∞—à —Ç–∞—Ä–∏—Ñ –µ—â–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /payment –¥–ª—è –æ–ø–ª–∞—Ç—ã –∏–ª–∏ /downgrade –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É —Ç–∞—Ä–∏—Ñ—É.',
        { parse_mode: 'Markdown' }
      );
      return;
    } else if (verificationCheck.reason === 'limit_reached') {
      // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
      bot.sendMessage(
        chatId,
        `‚ö†Ô∏è *–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤*\n\n–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /plans –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–≤–µ—Ä–æ–∫.`,
        { parse_mode: 'Markdown' }
      );
      return;
    }
  }
  
  try {
    console.log(`–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: ${fileName}`);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    const processingMsg = await bot.sendMessage(
      chatId, 
      `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...`
    );
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ
    const filePath = await downloadTelegramPhoto(fileId, bot, fileName);
    
    console.log(`–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${filePath}`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.editMessageText(
      `–ò–∑–≤–ª–µ–∫–∞—é —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –ø–æ–º–æ—â—å—é OCR...`, 
      {
        chat_id: chatId,
        message_id: processingMsg.message_id
      }
    );
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –ø–æ–º–æ—â—å—é OCR
    console.log('–ù–∞—á–∏–Ω–∞—é –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...');
    
    let documentText;
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥ extractTextFromDocument, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OCR –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      documentText = await extractTextFromDocument(filePath);
      console.log(`–¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω, —Ä–∞–∑–º–µ—Ä: ${documentText ? documentText.length : 0} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω
      if (!documentText || documentText.trim() === '') {
        throw new Error('–¢–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑ –º–æ–¥—É–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
      if (documentText.startsWith('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç')) {
        throw new Error(documentText);
      }
    } catch (extractError) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', extractError);
      
      let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.';
      
      if (extractError.message.includes('–Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω')) {
        errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–∫—Å—Ç —á–µ—Ç–∫–æ –≤–∏–¥–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —Å –ª—É—á—à–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º —Ñ–æ—Ç–æ.';
      }
      
      await bot.editMessageText(
        `‚ùå ${errorMessage}`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
      
      console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞: ${errorMessage}`);
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userSettings = getUserSettings(userId);
    
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω forceContract
    if (!shouldForceContract) {
      await bot.editMessageText(
        `–ü—Ä–æ–≤–µ—Ä—è—é, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–æ–º...`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
      const isContract = await isContractDocument(documentText);
      
      if (!isContract.result) {
        // –ï—Å–ª–∏ –≤ –ø–æ–¥–ø–∏—Å–∏ –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä –∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä
        await bot.editMessageText(
          `üìù –¢–µ–∫—Å—Ç –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä –∏–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç.\n\n–ï—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å –ø–æ–¥–ø–∏—Å—å—é "–¥–æ–≥–æ–≤–æ—Ä" –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.`, 
          {
            chat_id: chatId,
            message_id: processingMsg.message_id
          }
        );
        return;
      }
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    registerRequestUsage(userId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.editMessageText(
      `–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏...`, 
      {
        chat_id: chatId,
        message_id: processingMsg.message_id
      }
    );
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –º–µ—Ç–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, —á—Ç–æ –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
      const analysisResult = await analyzeDocumentWithSelectedModel(documentText);
      
      if (!analysisResult || !analysisResult.analysis) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
      await bot.editMessageText(
        analysisResult.analysis, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id,
          parse_mode: 'Markdown',
          reply_markup: {
            inline_keyboard: [
              [
                { text: "–Ø - —Ñ–∏–∑–ª–∏—Ü–æ", callback_data: `party_individual:${chatId}` },
                { text: "–Ø - —é—Ä–ª–∏—Ü–æ", callback_data: `party_legal:${chatId}` }
              ]
            ]
          }
        }
      );
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑ –≤ tempStorage –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      global.tempStorage.documentAnalysis[chatId] = {
        text: documentText,
        analysis: analysisResult.analysis,
        timestamp: Date.now()
      };
      
      console.log(`–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
    } catch (analysisError) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', analysisError);
      
      await bot.editMessageText(
        `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ${analysisError.message}`, 
        {
          chat_id: chatId,
          message_id: processingMsg.message_id
        }
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', error);
    
    bot.sendMessage(
      chatId,
      `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: ${error.message}`
    );
  }
}

module.exports = {
  handleDocument,
  handlePartySelection,
  handlePhoto,
  isContractDocument,
  handleTextMessage
}; 